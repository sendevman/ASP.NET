<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Entities</title>
<link type="text/css" rel="stylesheet" href="bootstrap.min.css" />
<style type="text/css">
.auto-style1 {
	text-decoration: underline;
}
</style>
</head>

<body>

<ul>
	<li><a href="#DocIntro">Introduction</a></li>
	<li>Pre-defined filters<ul>
		<li>ISoftDelete</li>
		<li>IMustHaveTenant</li>
		<li>IMayHaveTenant</li>
	</ul>
	</li>
	<li>Disable filters</li>
	<li>Enable filters</li>
	<li>Setting filter parameters</li>
	<li>Defining custom filters</li>
</ul>
<h3 id="DocIntro">Introduction</h3>
<p>It's common to use the <a href="/Pages/Documents/Entities#DocSoftDelete">
<strong>soft-delete</strong></a> pattern which is used to not delete an entity 
from database but only mark it as 'deleted'. So, if an entity is soft-deleted, 
it should not be accidently retrieved into the application. To provide that, we 
would add a SQL <strong>where</strong> condition like 'IsDeleted = false' in 
every query we select entities. This is a tedious but more importantly a 
forgettable task. So, there should be an automatic way of it.</p>
<p>ASP.NET Boilerplate provides <strong>data filters </strong>those can be used 
to automatically filter queries based on some rules. There are some pre-defined 
filters, but also you can create your own filters.</p>
<h3>Pre-defined filters</h3>
<h4>ISoftDelete</h4>
<p>Soft-delete filter is used to automatically filter (extract from results) 
deleted entities while querying database. If an
<a href="/Pages/Documents/Entities">entity</a> should be soft-deleted, it must 
implement <strong>ISoftDelete</strong> interface which defines only IsDeleted 
property. Example:</p>
<pre lang="cs">public class Person : Entity, ISoftDelete
{
    public virtual string Name { get; set; }

    public virtual bool IsDeleted { get; set; }
}</pre>
<p>A <strong>Person </strong>entity is not actually deleted from database, 
instead <strong>IsDeleted </strong>property is set to true when need to delete 
it. This is done automatically by ASP.NET Boilerplate when you use <strong>
<a href="/Pages/Documents/Repositories#DocDeleteEntity">IRepository.Delete</a></strong> 
method (you can manually set IsDeleted to true, but Delete method is more 
natural and preffered way).</p>
<p>After implementing ISoftDelete, when you get list of People from database, 
deleted people are not retrieved. Here, an example class that uses a person 
repository to get all people:</p>
<pre lang="cs">public class MyService
{
    private readonly IRepository&lt;Person&gt; _personRepository;

    public MyService(IRepository&lt;Person&gt; personRepository)
    {
        _personRepository = personRepository;
    }

    public List&lt;Person&gt; GetPeople()
    {
        return _personRepository.GetAllList();
    }
}</pre>
<p>GetPeople method only gets Person entities which has IsDeleted = false (not 
deleted). All repository methods and also navigation properties properly works. 
We could add some other Where conditions, joins.. etc. It will automatically add 
IsDeleted = false condition properly.</p>

<div class="bs-callout bs-callout-warning">
	<h4>When enabled?</h4>
	<p>ISoftDelete filter is always enabled unless you explicitly disable it.</p>
</div>

<p><span class="auto-style1">A side note</span>: If you implement
<a href="/Pages/Documents/Entities#DocSoftDelete">IDeletionAudited</a> (which 
extends ISoftDelete) then deletion time and deleter user id are also 
automatically set by ASP.NET Boilerplate.</p>
<h4>IMustHaveTenant</h4>
<p>If you are building multi-tenant applications (store all tenant datas in 
single database), you definitely do not want a tenant accidently see others 
data. You can implement <strong>IMustHaveTenant</strong> in that case. Example:</p>
<pre lang="cs">public class Product : IMustHaveTenant
{
    public virtual int TenantId { get; set; }
        
    public virtual string Name { get; set; }
}</pre>
<p><strong>IMustHaveTenant</strong> defines <strong>TenantId </strong>to 
distinguish different tenant entities. ASP.NET Boilerplate uses
<a href="/Pages/Documents/AbpSession">IAbpSession</a> to get current TenantId 
and automatically filter query for the current tenant.</p>

<div class="bs-callout bs-callout-warning">
	<h4>When enabled?</h4>
	<p>IMustHaveTenant is enabled by default.</p>
	<p>If current user is not logged in to the system or current user is a <strong>host</strong> user (Host user is an upper level user that can 
	manage tenants and tenant datas), ASP.NET Boilerplate automatically <strong>
	disables</strong> IMustHaveTenant filter. Thus, all data of all tenant's can be 
	retrieved to the application. Notice that this is not about security, you should 
	always <a href="/Pages/Documents/Authorization">authorize</a> sensitive data.</p>
</div>

<h4>IMayHaveTenant</h4>
<p>If an entity class shared by tenants and the host (that means an entity may 
be owned by a tenant or the host), you can use IMayHaveTenant filter. <strong>
IMayHaveTenant</strong> interface also defines <strong>TenantId</strong> but it's <strong>
nullable</strong>.</p>
<pre lang="cs">public class Product : IMayHaveTenant
{
    public virtual int? TenantId { get; set; }
        
    public virtual string Name { get; set; }
}</pre>
<p>A null value means this is a host entity, a non-null value means this entity 
owned by a tenant which's Id is the TenantId. ASP.NET Boilerplate uses
<a href="/Pages/Documents/AbpSession">IAbpSession</a> to get current TenantId. 
IMayHaveTenant filter is not common as much as 
IMustHaveTenant. But you may need it for common structures used by host and tenants.</p>

<div class="bs-callout bs-callout-warning">
	<h4>When enabled?</h4>
	<p>IMayHaveTenant is enabled by default.</p>
	<p>If current user is not logged in to the system, ASP.NET Boilerplate automatically <strong>
	disables</strong> IMayHaveTenant filter. Thus, all data of host's and all tenant's can be 
	retrieved to the application. Notice that this is not about security, you should 
	always <a href="/Pages/Documents/Authorization">authorize</a> sensitive 
	data.</p>
</div>

<h3>Disable filters</h3>
<p>You can disable a filter per <a href="/Pages/Documents/Unit-Of-Work">unit of 
work</a> by calling <strong>DisableFilter</strong> method as shown below:</p>
<pre lang="cs">var people1 = _personRepository.GetAllList();

using (_unitOfWorkManager.Current.DisableFilter(AbpDataFilters.SoftDelete))
{
    var people2 = _personRepository.GetAllList();                
}

var people3 = _personRepository.GetAllList();</pre>
<p>DisableFilter method gets one or more filter names as strings. 
AbpDataFilters.SoftDelete is a constant string that contains name of the soft 
delete filter.</p>
<p>people2 can also get deleted people while people1 and people3 will be only 
non-deleted people. With using statement, you can disable a filter in a scope. 
If you don't use using stamement, the filter will be disabled until end of the&nbsp; 
current unit of work or you enable it again.</p>
<p>You can inject IUnitOfWorkManager and use as in the example. Also, you can 
use CurrentUnitOfWork property as a shortcut in an application service (derived 
from ApplicationService class).</p>

<div class="bs-callout bs-callout-warning">
	<h4>About using statement</h4>
	<p>Note: If a filter is enabled when you call 
	the DisableFilter method with a using statement, the filter is disabled, then 
	automatically re-enabled after using statement. But if the filter was already 
	disabled before the using statement, DisableFilter actually does nothing and it remains disabled even after 
	the using statement.</p>
</div>

<h3>Enable filters</h3>
<p>You can enable a filter in a unit of work using <strong>EnableFilter </strong>
method, as similar to DisableFilter. EnableFilter also returns disposable to 
automatically re-disable the filter.</p>
<h3>Setting filter parameters</h3>
<p>A filter can be <strong>parametric</strong>. IMustHaveTenant filter is an 
example of these types of filters since current tenant's Id is determined on 
runtime. For such filters, we can change filter value if needed. Example:</p>
<pre lang="cs">CurrentUnitOfWork.SetFilterParameter("PersonFilter", "personId", 1);</pre>
<p>Another example: To set the tenantId value for the IMayHaveTenant&nbsp;filter:</p>
<pre lang="cs">CurrentUnitOfWork.SetFilterParameter(AbpDataFilters.MayHaveTenant, AbpDataFilters.Parameters.TenantId, 42);</pre>
<h3>Defining custom filters</h3>
<p>To create a custom filter and integrate to ASP.NET Boilerplate, first we 
should define an interface that will be implemented by entities which use this 
filter. Assume that we want to automatically filter entities by PersonId. 
Example interface:</p>
<pre lang="cs">public interface IHasPerson
{
    int PersonId { get; set; }
}</pre>
<p>Then we can implement this interface for needed entities. Example entity:</p>
<pre lang="cs">public class Phone : Entity, IHasPerson
{
    [ForeignKey("PersonId")]
    public virtual Person Person { get; set; }
    public virtual int PersonId { get; set; }

    public virtual string Number { get; set; }
}</pre>
<p>Since ASP.NET Boilerplate uses EntityFramework.DynamicFilters, we use it's 
rules to define the filter. In out DbContext class, we override OnModelCreating 
and define filter as shown below:</p>
<pre lang="cs">protected override void OnModelCreating(DbModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    modelBuilder.Filter("PersonFilter", (IHasPerson entity, int personId) =&gt; entity.PersonId == personId, 0);
}</pre>
<p>"PersonFilter" is the unique name of the filter. Second parameter defines 
filter interface and personId filter parameter (not needed if filter is not 
parametric), last parameter is the default value of the personId.</p>
<p>The last thing we should do to register this filter to ASP.NET Boilerplate's 
unit of work system in PreInitialize method of our module:</p>
<pre lang="cs">Configuration.UnitOfWork.RegisterFilter("PersonFilter", false);</pre>
<p>First parameter is same unique name we defined before. Second parameter sets 
if this filter is enabled by default.</p>
<p>...</p>
<p>TODO-NOTE: Data filters are not implemented in NHibernate!</p>

</body>

</html>
